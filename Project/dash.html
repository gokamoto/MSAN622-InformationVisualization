<!DOCTYPE html>
<meta charset="utf-8">

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>


<h1 id="dashTitle"> 311 Cases - Muni Feedback </h1>
<div id="dashboard">
	<div id="mapChart"></div>
	<svg id="barChart"></svg>
	<svg id="lineChart"></svg>
</div>


<style>

div#dashboard {
    max-width: 1000px;
    /*max-height: 620px;*/
}

#dashTitle {
	font-family: sans-serif;
	font-size: 24px;
}

svg {
	float: left;
}

#mapChart {
	background-color: #D1F0FF;
}

.land {
    fill: #D1D1D1;
}

.land:hover{
	fill: white;
}

.boundary {
    fill: none;
    stroke: white;
}

.d3-tip {
  line-height: 1;
  /*font-weight: bold;*/
  padding: 10px;
  /*background: rgba(0, 0, 0, 0.8);*/
  background: #fff;
  color: black;
  border-radius: 2px;
  font-family: sans-serif;
  font-size: 12px;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  /*color: rgba(0, 0, 0, 0.8);*/
  color: white;
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}

.tick text {
	font-family: sans-serif;
	font-size: 10px;
}

.x.axis line,
.x.axis path {
	fill: none;
	stroke: #000;
	shape-rendering: crispEdges;
}

.y.axis path {
	display: none;
}

.y.axis line {
  stroke: #ddd;
}

.y.axis text {
	font-family: sans-serif;
	font-size: 10px;
}

</style>


<script>

var allWidth = 1000,
    allHeight = 620;
   	
var color = d3.scale.ordinal()
				.domain(["Commendation", "Criminal Activity", "Delivery Facilities",
					"Inappropriate Conduct", "Miscellaneous", "Negligence",
					"Service Planning", "Unsafe Operation"])
				.range(["#1b9e77","#d95f02","#7570b3","#e7298a","#66a61e","#e6ab02","#666666"]);


function map() {

	var width = .7*allWidth,
		height = allHeight,
		active = d3.select(null);


	var tip = d3.tip()
		.attr('class', 'd3-tip')
		.offset([-10, 0])
		.html(function(d) {
	    	return "<div>" + d.Address + "</div>"
	    	+ "<div>" + d.Neighborhood + "</div>" 
	    	+ "<div><strong> Request Type:</strong> " + d["Request.Type2"] + "</div>"
	    	+ "<div><strong> Details:</strong> " + d["Request.Details"] + "</div>";
	  	})

	var svg = d3.select("#mapChart").append("svg")
	    .attr("width", width)
	    .attr("height", height)
	    .style("background-color", '#D1F0FF');

	svg.call(tip);

	d3.json("pl_n.json", function(error, ca) {

	    var featureCollection = topojson.feature(ca, ca.objects.planning_neighborhoods);
	    var bounds = d3.geo.bounds(featureCollection);

	    var centerX = d3.sum(bounds, function(d) {return d[0];}) / 2,
	        centerY = d3.sum(bounds, function(d) {return d[1];}) / 2;

	    var projection = d3.geo.mercator()
	        .scale(240000)
	        // .translate([width / 2, height / 2])
	        .center([centerX+.03, centerY+0.007]);

	    var path = d3.geo.path()
	        .projection(projection);

	    var g = svg.append("g")
    		.style("stroke-width", "1.5px");

	    g.selectAll("path")
	        .data(featureCollection.features)
	        .enter().append("path")
	        .attr("class", "land")
	        .classed("feature", true)
	        .attr("d", path)
	        .on("click", clicked);

	    g.append("path")
	        .datum(topojson.mesh(ca, ca.objects.planning_neighborhoods, function(a, b) { return a !== b; }))
	        .attr("class", "boundary")
	        .attr("d", path);
	        

	    d3.json("sf311_just2015_muni.json", function(dataError, data) {

	        data.forEach(function(d) {
	            var loc = d.Point.split(",");
	            d.latitude = loc[0].slice(1);
	            d.longitude = loc[1].slice(1,-1);
	        })

	        var dots = g.append("g")
	            .attr("class", "dots")

	        var dotGroups = g.selectAll(".dot")
	            .data(data)
	            .enter().append("g")
	                .attr("class", "dot");

	        dotGroups.append("circle")
	            .attr("r", 4)
	            .attr("cx", function(d, i) {
	                // projection takes [longitude, latitude]
	                // and returns [x, y] as output
	                return projection([d.longitude, d.latitude])[0];
	            })
	            .attr("cy", function(d, i) {
	                return projection([d.longitude, d.latitude])[1];
	            })
	            .style("fill", function(d) {
	                return color(d["Request.Type2"]);
	            })
	            // .style("opacity", 0.7)
	            .on('mouseover', tip.show)
	            .on('mouseout', tip.hide);
	    });

	function clicked(d) {

		if (active.node() === this) return reset();
		active.classed("active", false);
		active = d3.select(this).classed("active", true);

		var bounds = path.bounds(d),
	    	dx = bounds[1][0] - bounds[0][0],
	    	dy = bounds[1][1] - bounds[0][1],
	    	x = (bounds[0][0] + bounds[1][0]) / 2,
	    	y = (bounds[0][1] + bounds[1][1]) / 2,
	    	scale = .9 / Math.max(dx / width, dy / height),
	    	translate = [width / 2 - scale * x, height / 2 - scale * y];

		g.transition()
	    	.duration(750)
	    	// .style("stroke-width", 1.5 / scale + "px")
	    	.attr("transform", "translate(" + translate + ")scale(" + scale + ")");

	  	g.selectAll("circle").transition().duration(750)
	  		.attr("r", 5/Math.sqrt(scale));
	}

	function reset() {
	  active.classed("active", false);
	  active = d3.select(null);

	  g.transition()
	      .duration(750)
	      // .style("stroke-width", "1.5px")
	      .attr("transform", "");

	  g.selectAll("circle").transition().duration(750)
	  		.attr("r", 4);
	}

	});
}

map();

function barchart(nbhd) {

	var margin = {top: 20, right: 5, bottom: 30, left: 120},
		width = 0.3*allWidth - margin.left - margin.right,
		height = 0.5*allHeight - margin.top - margin.bottom;

	svg = d3.select("#barChart")
	    .attr("width", width + margin.left + margin.right)
	    .attr("height", height + margin.top + margin.top)
	    .append("g")
    		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	var y = d3.scale.ordinal()
		.rangeRoundBands([height, 0], .1);

	var x = d3.scale.linear()
	    .range([0, width])
	    .nice();

	var yAxis = d3.svg.axis()
	    .scale(y)
	    .orient("left");

	var xAxis = d3.svg.axis()
	    .scale(x)
	    .orient("bottom")
	    .ticks(5); 

	d3.json("muni_category_nbhd.json", function(error, data) {

		var nested_data = {};

		data.forEach(function(d) {
			nested_data[d.Neighborhood] = d;
			delete nested_data[d.Neighborhood]["Neighborhood"];
		})

		console.log(data);
		console.log(nested_data);

		nbhd_data = nested_data[nbhd];

		var counts = [];
		for(var key in nbhd_data) {
		    var value = nbhd_data[key];
		    counts.push(value);
		}

		y.domain(Object.keys(nbhd_data));
		x.domain(d3.extent(counts));

		svg.append("g")
	    	.data(data)
			.attr("class", "x axis")
			.attr("transform", "translate(0," + (height) + ")")
			.call(xAxis)
			.selectAll("text")  
	            .style("text-anchor", "middle")
	            .attr("dx", "0")
	            .attr("dy", "1em");

	    svg.append("g")
			.attr("class", "y axis")
			.call(yAxis)
		.append("text")
			// .attr("transform", "rotate(-90)")
			.attr("x", width + margin.right)
			.attr("y", height - 10)
			.style("text-anchor", "end")
			.style("font-weight", "bold")
			.text("Count");

		var bars = svg.append("g")
			.attr("class", "bars");

		var barGroup = bars.selectAll(".bar")
			.data(d3.entries(nbhd_data))
			.enter().append("g");

		barGroup.append("rect")
			.attr("class", function(d) { return d.key; })
			.attr("y", function(d) { 
				return y(d.key); 
			})
			.attr("height", y.rangeBand())
			.attr("x", function(d) { return 0; })
			.attr("width", function(d) { return x(d.value); })
			.style("fill", function(d) {
				return color(d.key);
			});

	})

}


barchart("All Neighborhoods");







</script>

